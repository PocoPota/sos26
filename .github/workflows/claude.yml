name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  # pull_request_review:
  #   types: [submitted]  # まずは外すのを推奨

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude:
    # 「@claude review」以外は動かさない（eventごとに body の場所が違う）
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude review')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude review'))

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: "@claude"

          # 進捗チェックリストを抑止
          track_progress: false
          include_fix_links: false   # Fix this → のリンクが要らないなら

          # ここが「system_prompt の代替」
          prompt: |
            あなたのタスクは「コードレビューのみ」です。実装は絶対にしません。

            禁止:
            - ファイル編集・新規作成・コミット・プッシュ（試行も禁止）
            - TODO/チェックリスト/進捗報告/「作業中です」形式のコメント
            - 「修正します/追加します/対応します」等の作業宣言
            - 表（Markdown table）の使用

            実施:
            - mcp__github__create_pending_pull_request_review でレビュー開始
            - mcp__github__get_pull_request_diff で差分取得
            - 指摘は原則すべて mcp__github__add_comment_to_pending_review でインライン投稿
            - submit は必ず COMMENT タイプ
            - ブロックコメントは 3〜6 行の短いサマリーのみ（詳細は書かない）

          # これは残してOK（ただし「Actionが勝手に他ツールを許可する」挙動は prompt 側で抑える）
          claude_args: >-
            --allowedTools "mcp__github__create_pending_pull_request_review,mcp__github__add_comment_to_pending_review,mcp__github__submit_pending_pull_request_review,mcp__github__get_pull_request_diff,Read,Glob,Grep"
